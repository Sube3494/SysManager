# 🔧 群组限制调试指南

## 问题：群组限制不生效

### 第1步：获取群号

在目标群中发送：
```
/sys info
```

查看返回信息中的群号：
```
会话信息:
Session ID: aiocqhttp:GroupMessage:123456789  <-- 这里
用户 ID: 987654321
管理员: 是
配置的群组: []                               <-- 当前配置
当前群号: 123456789                          <-- 解析出的群号
权限检查: 通过                               <-- 权限状态
```

### 第2步：配置群组白名单

#### 方法A：通过Web面板
1. 打开 AstrBot Web面板
2. 进入 插件管理 → SysManager → 配置
3. 在 `enabled_groups` 中填入群号：
   ```
   [123456789, 987654321]
   ```
4. 保存配置
5. 重启插件

#### 方法B：直接编辑配置文件
1. 编辑 `data/config/SysManager_config.json`
2. 修改 `enabled_groups`：
   ```json
   {
     "sysmanager": {
       "enabled_groups": [123456789, 987654321],
       "command_timeout": 30,
       "max_output_length": 2000,
       "log_operations": true
     }
   }
   ```
3. 保存文件
4. 重启插件

### 第3步：验证配置

重启后，查看控制台日志：
```
✅ 服务器管理插件已加载
   管理员数量: 2
   生效范围: 2个指定群
   群组列表: [123456789, 987654321]  <-- 确认群号在列表中
```

再次在群里发送 `/sys info` 确认：
```
配置的群组: [123456789, 987654321]
当前群号: 123456789
权限检查: 通过  <-- 应该显示"通过"
```

## 常见问题

### 1. Session ID 格式不同

不同的QQ框架可能有不同格式：
- OneBot: `aiocqhttp:GroupMessage:123456789`
- Mirai: `mirai:GroupMessage:123456789`
- 其他: 可能直接是群号

**解决方案：** 使用 `/sys info` 查看实际格式

### 2. 群号类型问题

配置中应该使用数字，不要加引号：
- ✅ 正确：`[123456789]`
- ❌ 错误：`["123456789"]`

### 3. 配置未生效

确保：
1. 配置已保存
2. 插件已重启
3. 没有语法错误（检查JSON格式）

### 4. 私聊总是允许

即使配置了群组限制，管理员私聊仍可使用。这是设计如此。

## 调试日志

如果还有问题，检查AstrBot控制台：
```
[INFO] Session ID: aiocqhttp:GroupMessage:123456789
[INFO] 群 123456789 不在白名单中，白名单: [987654321]
```

这会告诉你：
- 实际的Session ID格式
- 解析出的群号
- 配置的白名单

## 完整调试流程

```bash
# 1. 查看当前状态
/sys info

# 2. 如果群号不在白名单
# 去Web面板添加群号，或编辑配置文件

# 3. 重启插件

# 4. 再次验证
/sys info

# 5. 测试命令
/sys pwd
```

## 联系支持

如果按以上步骤操作后仍有问题：
1. 截图 `/sys info` 的输出
2. 提供配置文件内容
3. 提供控制台日志
4. 说明使用的QQ框架（go-cqhttp、Mirai等）

---

**提示：** `/sys info` 命令是调试群组权限的最佳工具！
